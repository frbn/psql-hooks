digraph hooks {
    //rankdir=TR
    node [shape=box];
    nodesep=0.5;
    ExecutorCheckPerms_hook     [shape=ellipse];
    create_upper_paths_hook     [shape=ellipse];
    check_passsword_hook        [shape=ellipse];
    ClientAuthentification_hook [shape=ellipse];
    explain_get_index_name_hook [shape=ellipse];
    emit_log_hook               [shape=ellipse][label="emit_log_hook\n(custom logging process)"];
    ExplainOneQuery_hook        [shape=ellipse];
    needs_fmgr_hook             [shape=ellipse];


	subgraph cluster_0 {label="(fnmgr)" ;
    	fmgr_hook1                  [shape=ellipse][label="fmgr_hook \n(security policy before)"];
    	fmgr_hook2                  [shape=ellipse][label="fmgr_hook \n(security policy after)"];
    	func_init                   [shape=ellipse][label="func_init \n(before var init)"];
    	func_beg                    [shape=ellipse][label="func_beg \n(after var init)"];
    	func_end                    [shape=ellipse][label="func_end \n(CallBack)"];
    	ExecutorRun_hook            [shape=ellipse][label="ExecutorRun_hook"];
    	ExecutorFinish_hook            [shape=ellipse][label="ExecutorFinish_hook"];
    	ExecutorEnd_hook            [shape=ellipse][label="ExecutorEnd_hook"];

    	"Statement of a function" ;
      "Execution of a function" ;
    	needs_fmgr_hook             [shape=ellipse];
    	stmt_beg                    [shape=ellipse];
    	stmt_end                    [shape=ellipse];

    	"Execution of a function" -> fmgr_hook1;
    	fmgr_hook1 -> func_init  -> func_beg;
    	stmt_beg -> "Statement of a function" ;
      planner_hook -> needs_fmgr_hook ;
      needs_fmgr_hook -> ExecutorStart ;
      needs_fmgr_hook -> ExecutorRun_hook -> fmgr_hook1 -> planner_hook;
    	"Statement of a function" -> planner_hook ;
      standard_planner -> ExecutorStart -> stmt_end;
    	func_beg -> stmt_beg;
    	stmt_end -> func_end;
    	func_end -> fmgr_hook2 ;
      fmgr_hook2 -> ExecutorFinish_hook -> ExecutorEnd_hook;

    }

 	subgraph cluster_1 { label="Object access";
    	object_access_hook          [shape=ellipse];

    	"OAT_POST_CREATE" -> object_access_hook;
    	"OAT_POST_ALTER" -> object_access_hook;
    	object_access_hook -> "OAT_DROP";
    	object_access_hook -> "OAT_NAMESPACE_SEARCH";
    	object_access_hook -> "OAT_FUNCTION_EXECUTE";
    }


	subgraph cluster_2 {
	label="STARTUP";
    	shmem_startup_hook          [shape=ellipse];

    	"POSTMASTER START" -> shmem_startup_hook ;
    	"BACKEND START" -> shmem_startup_hook ;
    	shmem_startup_hook -> "on_shmem_exit CallBack";
    }

    "Access to a relation" ->  ExecutorCheckPerms_hook;

	subgraph cluster_3 {
    label="Query Plan Execution";
    QPExecutorStart_hook          [shape=ellipse][label="ExecutorStart_hook"];
    QPExecutorCheckPerms_hook     [shape=ellipse][label="ExecutorCheckPerms_hook"];
    QPExecutorRun_hook            [shape=ellipse][label="ExecutorRun_hook"];
    QPExecutorEnd_hook            [shape=ellipse][label="ExecutorEnd_hook"];
    QPExecutorFinish_hook [shape=ellipse][label="ExecutorFinish_hook\n(After last ExecutorRun call)"];
		"ExecutorStart"
        -> QPExecutorStart_hook
        -> QPExecutorCheckPerms_hook
		    -> QPExecutorRun_hook
        -> QPExecutorFinish_hook
		    -> QPExecutorEnd_hook
    	-> "end of query plan";
	}

	subgraph cluster_4 {
	label="ROLE"

		subgraph cluster_5 {
		label="Alteration";
    		{ CREATE_ROLE, ALTER_ROLE } -> check_passsword_hook ;
    	}

		subgraph cluster_6 {
		label="Authentification";
    		AFTER_USER_AUTHENTIFICATION -> ClientAuthentification_hook ;
		}
	}



    get_attavgwidth_hook        [shape=ellipse][label="get_attavgwidth_hook \n(replace standard algorythm)"];

    get_index_stats_hook        [shape=ellipse];

    get_relation_info_hook      [shape=ellipse];
    "get_relation_info()" -> get_relation_info_hook;

    get_relation_stats_hook     [shape=ellipse];

    join_search_hook            [shape=ellipse];
    "Optimizer chooses order of join relations" -> join_search_hook;


    planner_hook                [shape=ellipse];
    planner_hook -> standard_planner-> Query_Optimizer;

    post_parse_analyze_hook     [shape=ellipse];
    parse_analyze -> "transformTopLevelStmt()" -> post_parse_analyze_hook;

    ProcessUtility_hook         [shape=ellipse];
    ProcessUtility_hook -> "standard_ProcessUtility()";

    row_security_policy_hook_permissive     [shape=ellipse];
    row_security_policy_hook_restrictive    [shape=ellipse];
    "ACCESS TO AN OBJECT" -> row_security_policy_hook_permissive -> row_security_policy_hook_restrictive;

    set_join_pathlist_hook      [shape=ellipse];
    "joinrel (best paths)" -> set_join_pathlist_hook;

    set_rel_pathlist_hook       [shape=ellipse];
    "End of building acces paths for a relation" -> set_rel_pathlist_hook;
    "postprocess of the path of set operations"
        -> create_upper_paths_hook
        -> contribute_path_in_relation ;

    "something to log"
        -> emit_log_hook
        -> "Standard log process"  ;
}
